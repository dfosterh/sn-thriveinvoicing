<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_175353_thriveinv.ThriveInvoiceUtil</api_name>
        <client_callable>false</client_callable>
        <description/>
        <name>ThriveInvoiceUtil</name>
        <script><![CDATA[var ThriveInvoiceUtil = Class.create();
ThriveInvoiceUtil.AdjustmentReason = [];

ThriveInvoiceUtil.SetInvoiceDetails = function(invoice) {
	try {
		var priorDetail = new GlideRecord('x_175353_thriveinv_invoice_details');
		priorDetail.addQuery('invoice', invoice.sys_id);
		priorDetail.deleteMultiple();

		var teTotal = ThriveInvoiceUtil.SetInvoiceDetailsTE(invoice.sys_id);
		var mrrTotal = ThriveInvoiceUtil.SetInvoiceDetailsMRR(invoice.sys_id, invoice.customer.sys_id);
		
		gs.addInfoMessage(gs.getMessage('Invoice detail records generated.'));
		
		var inv = new GlideRecord('x_175353_thriveinv_invoices');
		inv.get(invoice.sys_id);
		inv.te_total = teTotal;
		inv.mrr_total = mrrTotal;
		inv.update();
	}
	catch(ex) {
		gs.addErrorMessage('Error in ThriveInvoiceUtil.SetInvoiceDetails: ' + ex.message);
	}
};

ThriveInvoiceUtil.SetInvoiceDetailsTE = function(invoiceID) {
	try {
		var te = new GlideRecord('task_time_worked');
		te.addQuery('x_175353_thriveinv_invoice', invoiceID);
		te.query();

		var returnValue = 0;
		while (te.next()) {
			var detail = new GlideRecord('x_175353_thriveinv_invoice_details');
			detail.initialize();
			
			detail.invoice = invoiceID;
//			detail.time_entry = te.sys_id;
			detail.sourceidlink = '/task_time_worked.do?sys_id=' + te.sys_id;
			detail.item = 'Time Entry';
			detail.detail = te.comments;
			detail.billed_hours = te.x_175353_thriveinv_billed_hours;
			detail.billed_rate = te.x_175353_thriveinv_billed_rate;
			detail.billed_amount = te.x_175353_thriveinv_billed_hours * te.x_175353_thriveinv_billed_rate;
			returnValue += parseFloat(detail.billed_amount);
			
			detail.insert();
		}

		gs.addInfoMessage(gs.getMessage('TE Invoice detail records generated for {0}.', [returnValue]));
		
		return returnValue;
	}
	catch(ex) {
		gs.addErrorMessage('Error in ThriveInvoiceUtil.SetInvoiceDetails: ' + ex.message);
	}
};

ThriveInvoiceUtil.SetInvoiceDetailsMRR = function(invoiceID, companyID) {
	try {
		var mrr = new GlideAggregate('x_175353_contracts_m2m_configuratio_entitlements');
		mrr.addQuery('configuration_item.company.sys_id', companyID);

		mrr.addAggregate('COUNT');
		mrr.setGroup(true);
		mrr.groupBy('entitlements');
		mrr.query();

		var returnValue = 0;
		while (mrr.next()) {
			var amount = mrr.getAggregate('COUNT');
			
			var detail = new GlideRecord('x_175353_thriveinv_invoice_details');
			detail.initialize();
			
			detail.invoice = invoiceID;
			detail.sourceidlink = '/x_175353_contracts_entitlement.do?sys_id=' + mrr.entitlements.sys_id;
			detail.item = mrr.entitlements.description; //ent.entitlements.service_portfolio_item.sku;
			detail.detail = 'Billed for next month';
			detail.billed_hours = amount;
			detail.billed_rate = mrr.entitlements.unit_price;
			detail.billed_amount = amount * mrr.entitlements.unit_price;
			returnValue += parseFloat(detail.billed_amount);
			
			detail.insert();
		}

		gs.addInfoMessage(gs.getMessage('MRR Invoice detail records generated for {0}.', [returnValue]));
		
		return returnValue;
	}
	catch(ex) {
		gs.addErrorMessage('Error in ThriveInvoiceUtil.SetInvoiceDetails: ' + ex.message);
	}
};

ThriveInvoiceUtil.SetInvoiceDetailsMRRProrated = function(invoiceID, companyID) {
	try {
		/*
		Start = earliest of Date Provisioned or created (this will count when provisioned, even if Date Provisioned is pushed later) where event <> deleted
		End = latest created where event = deleted
		Where: CI, Date Provisioned or created in period
		*/

var startPeriodDate = Date.parse('8/15/2018');
var endPeriodDate = Date.now();

		var mrr = new GlideRecord('x_175353_contracts_entitlement_history');
		mrr.addQuery('configuration_item.company.sys_id', companyID);
		mrr.addQuery('granted_to', 'CI');

/*		var dateStart = BOM
		var dateEnt = EOM

order by entitlements, created
if not deleted, reset dateStart to earliest
if deleted, reset endDate
write and restart dates
*/		
		var returnValue = 0;
		while (mrr.next()) {
			var amount = mrr.getAggregate('COUNT');
			
			var detail = new GlideRecord('x_175353_thriveinv_invoice_details');
			detail.initialize();
			
			detail.invoice = invoiceID;
			detail.sourceidlink = '/x_175353_contracts_entitlement.do?sys_id=' + mrr.entitlements.sys_id;
			detail.item = mrr.entitlements.description; //ent.entitlements.service_portfolio_item.sku;
			detail.detail = 'Billed for next month';
			detail.billed_hours = amount;
			detail.billed_rate = mrr.entitlements.unit_price;
			detail.billed_amount = amount * mrr.entitlements.unit_price;
			returnValue += parseFloat(detail.billed_amount);
			
			detail.insert();
		}

		gs.addInfoMessage(gs.getMessage('MRR Invoice detail records generated for {0}.', [returnValue]));
		
		return returnValue;
	}
	catch(ex) {
		gs.addErrorMessage('Error in ThriveInvoiceUtil.SetInvoiceDetails: ' + ex.message);
	}
};

ThriveInvoiceUtil.SetTimeInvoiced = function(invoice) {
	try {
		var te = new GlideRecord('task_time_worked');
		var qry = gs.getMessage('task.sys_domain={0}^x_175353_thriveinv_invoiceISEMPTY^ORx_175353_thriveinv_invoice={1}', [invoice.sys_domain, invoice.sys_id]);
		te.addQuery(qry);
		te.query();

		while (te.next()) {
			var wrRate = ThriveInvoiceUtil.GetWorkRoleRate(1, te.x_175353_thriveinv_work_role, te.task.company, null, te.task.parent);
			if(!wrRate) {
				te.x_175353_thriveinv_has_billing_issue = true;
				te.x_175353_thriveinv_adjustment_reason = 'Failed to get Work Role rate';
			}
			
			var workType = ThriveInvoiceUtil.GetWorkType(2, te.x_175353_thriveinv_work_type, te.task.company, null, te.task.parent);
			if(!workType) {
				te.x_175353_thriveinv_has_billing_issue = true;
				te.x_175353_thriveinv_adjustment_reason = 'Failed to get Work Type';
			}
			
			if(wrRate && workType) {
				te.x_175353_thriveinv_invoice = invoice.sys_id;
				te.x_175353_thriveinv_billed_rate = ThriveInvoiceUtil.GetBilledRate(3, wrRate, workType);
				te.x_175353_thriveinv_billed_hours = ThriveInvoiceUtil.GetBilledHours(4, te.time_in_seconds, workType);
				te.x_175353_thriveinv_adjustment_reason = ThriveInvoiceUtil.AdjustmentReason.sort(function(a, b) {
					return a.order - b.order;
				}).map(function(a) {
					return a.value;
				}).join("; ");

				//for some reason, clearing this at the beginning does not work. Need to clear it after I'm done like this
				ThriveInvoiceUtil.AdjustmentReason.length = 0;

				te.x_175353_thriveinv_has_billing_issue = false;
			}

			
			
			te.update();
		}

		gs.addInfoMessage(gs.getMessage('All non-invoiced Time Worked records have been updated with invoice details.'));
	}
	catch(ex) {
		gs.addErrorMessage('Error in ThriveInvoiceUtil.SetTimeInvoiced: ' + ex.message);
	}
};
	
ThriveInvoiceUtil.GetBilledRate = function(messageOrder, wrRate, workType) {
	var returnValue;

	switch(workType.price_adjustment_type.toString()) {
		case 'adjustment':
			returnValue = parseFloat(wrRate) + parseFloat(workType.price_adjustment);
			ThriveInvoiceUtil.AdjustmentReason.push({
				order: messageOrder,
				value: gs.getMessage('Rate adjusted by ${0} from Work Type', [workType.price_adjustment.toString()])
			});
			break;
		case 'multiplier':
			returnValue = wrRate * workType.price_adjustment;
			ThriveInvoiceUtil.AdjustmentReason.push({
				order: messageOrder,
				value: gs.getMessage('Rate multiplied by {0} from Work Type', [workType.price_adjustment.toString()])
			});
			break;
		case 'override':
			returnValue = workType.price_adjustment;
			ThriveInvoiceUtil.AdjustmentReason.push({
				order: messageOrder,
				value: gs.getMessage('Rate overridden to ${0} from Work Type', [workType.price_adjustment.toString()])
			});
			break;
		default:
			gs.addErrorMessage('There is a Price Adjustment Type in Work Types that does not yet have a calculation.');
	}

	return returnValue;
};

ThriveInvoiceUtil.GetBilledHours = function(messageOrder, teSeconds, workType) {
	//1st minute is not counted. We can make it first 30-seconds with round, or just let any second over round up
	var teMinutes = Math.floor(teSeconds / 60);

	if(workType.round_to_minutes && workType.round_to_minutes > 0) {
		//round up
		if (teMinutes % workType.round_to_minutes > 0) {
			teMinutes = workType.round_to_minutes * (Math.floor(teMinutes / workType.round_to_minutes) + 1);
		}

		ThriveInvoiceUtil.AdjustmentReason.push({
			order: messageOrder,
			value: gs.getMessage('Hours rounded to the nearest {0} minutes from Work Type', [workType.round_to_minutes.toString()])
		});	}

	return teMinutes / 60;
};

ThriveInvoiceUtil.GetWorkRoleRate = function(messageOrder, workRoleId, companyId, contractId, projectId) {
	if(!workRoleId) {
		gs.addErrorMessage('There is a Time Entry with no Work Role selected.');
		return null;
	}
	
	var wrRate;
	
//RISK: projectId is parent. Need to check class or other attribute to make sure this is pointing to a project. What about nested tasks? Also need to make sure Company does not get picked up off of project/contract overrides.
	if (projectId) {
		 wrRate = ThriveInvoiceUtil.GetWorkRoleRateForProject(workRoleId, projectId);
	}
	
	if (wrRate) {
		ThriveInvoiceUtil.AdjustmentReason.push({
			order: messageOrder,
			value: gs.getMessage('Work Role rate ${0} from Project Override', [wrRate])
		});
	}
	else {
		if (companyId) {
			wrRate = ThriveInvoiceUtil.GetWorkRoleRateForCompany(workRoleId, companyId);
		}
	
		if (wrRate) {
			ThriveInvoiceUtil.AdjustmentReason.push({
				order: messageOrder,
				value: gs.getMessage('Work Role rate ${0} from Company Override', [wrRate])
			});
		}
		else {
			wrRate = ThriveInvoiceUtil.GetWorkRoleRateDefault(workRoleId);
			ThriveInvoiceUtil.AdjustmentReason.push({
				order: messageOrder,
				value: gs.getMessage('Default Work Role rate ${0}', [wrRate])
			});
		}
	}
	
	return wrRate;
};

ThriveInvoiceUtil.GetWorkType = function(messageOrder, workTypeId, companyId, contractId, projectId) {
	if(!workTypeId) {
		gs.addErrorMessage('There is a Time Entry with no Work Type selected.');
		return null;
	}

	var returnValue;
	
	if (projectId) {
		 returnValue = ThriveInvoiceUtil.GetWorkTypeForProject(workTypeId, projectId);
	}
	
	if (returnValue) {
		ThriveInvoiceUtil.AdjustmentReason.push({
			order: messageOrder,
			value: gs.getMessage('Work Type from Project Override')
		});
	}
	else {
		if(companyId) {
			returnValue = ThriveInvoiceUtil.GetWorkTypeForCompany(workTypeId, companyId);
		}
		
		if (returnValue) {
			ThriveInvoiceUtil.AdjustmentReason.push({
				order: messageOrder,
				value: gs.getMessage('Work Type from Company Override')
			});
		}
		else {
			returnValue = ThriveInvoiceUtil.GetWorkTypeDefault(workTypeId);
			ThriveInvoiceUtil.AdjustmentReason.push({
				order: messageOrder,
				value: gs.getMessage('Work Type from Default')
			});
		}
	}

	return returnValue;
};

ThriveInvoiceUtil.GetWorkRoleRateForProject = function(workRoleId, projectId) {
	var wr = new GlideRecord('x_175353_thriveinv_labor_rate_card_overrides');
	wr.addQuery('overridden_work_role', workRoleId);
	wr.addQuery('project', projectId);
	wr.query();

	if(wr.next()) {
		return wr.hourly_rate;
	}
};

ThriveInvoiceUtil.GetWorkRoleRateForCompany = function(workRoleId, companyId) {
	var wr = new GlideRecord('x_175353_thriveinv_labor_rate_card_overrides');
	wr.addQuery('overridden_work_role', workRoleId);
	wr.addQuery('company', companyId);
	wr.addQuery('contract', null);
	wr.addQuery('project', null);
	wr.query();

	if(wr.next()) {
		return wr.hourly_rate;
	}
};

ThriveInvoiceUtil.GetWorkRoleRateDefault = function(workRoleId) {
	var wr = new GlideRecord('fm_labor_rate_card');
	wr.get(workRoleId);
	return wr.hourly_rate;
};

ThriveInvoiceUtil.GetWorkTypeForProject = function(workTypeId, projectId) {
	var wt = new GlideRecord('x_175353_thriveinv_work_type_overrides');
	wt.addQuery('overridden_work_type', workTypeId);
	wt.addQuery('project', projectId);
	wt.query();

	if(wt.next()) {
		return wt;
	}
};

ThriveInvoiceUtil.GetWorkTypeForCompany = function(workTypeId, companyId) {
	var wt = new GlideRecord('x_175353_thriveinv_work_type_overrides');
	wt.addQuery('overridden_work_type', workTypeId);
	wt.addQuery('company', companyId);
	wt.addQuery('contract', null);
	wt.addQuery('project', null);
	wt.query();

	if(wt.next()) {
		return wt;
	}
};

ThriveInvoiceUtil.GetWorkTypeDefault = function(workTypeId) {
	var wt = new GlideRecord('x_175353_thriveinv_work_types');
	wt.get(workTypeId);
	return wt;
};
]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2018-08-13 19:35:01</sys_created_on>
        <sys_id>ce2ab99f4fb313002e7e8020a310c743</sys_id>
        <sys_mod_count>186</sys_mod_count>
        <sys_name>ThriveInvoiceUtil</sys_name>
        <sys_package display_value="Thrive Invoices" source="x_175353_thriveinv">d742b9934f3313002e7e8020a310c7e3</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Thrive Invoices">d742b9934f3313002e7e8020a310c7e3</sys_scope>
        <sys_update_name>sys_script_include_ce2ab99f4fb313002e7e8020a310c743</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2018-09-04 14:59:07</sys_updated_on>
    </sys_script_include>
</record_update>
